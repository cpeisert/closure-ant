<?xml version="1.0" encoding="UTF-8"?>
<!--
Copyright (C) 2012 Christopher Peisert. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<project name="closure-ant" basedir="." default="jar">
  
  <!--
  ==============================================================================
    Inputs to the build process.
  ==============================================================================
  -->

  <property name="src.dir" value="${basedir}/src" />
  <property name="lib.dir" value="${basedir}/lib" />
  <property name="resources.dir" value="${basedir}/resources" />
  <property name="test.dir" value="${basedir}/test" />
  <property name="closure-tools-config.xml"
      value="${resources.dir}/closure-tools-config.xml" />
                             
  <path id="classpath">
    <fileset dir="${lib.dir}" includes="**/*.jar" />
    <fileset dir="${test.dir}/lib" includes="*antunit*.jar" />
  </path>


  <!--
  ==============================================================================
    Outputs from the build process.
  ==============================================================================
  -->

  <property name="build.dir" location="${basedir}/build" />
  <property name="classes.dir" location="${build.dir}/classes" />
  <property name="closure-ant.jar" 
      location="${build.dir}/closure-ant.jar" />
   <property name="closure-ant-no-ant-deps.jar"
       location="${build.dir}/closure-ant-no-ant-deps.jar" />
  <property name="closure-ant-no-deps.jar"
      location="${build.dir}/closure-ant-no-deps.jar" />
  <property name="builderplus.jar" location="${build.dir}/builderplus.jar" />

  <property name="javadoc.dir" value="${build.dir}/javadoc" />

  <!--
    To release a new stable version of closure-ant, change
    release.stamp to "latest" or pass -Drelease.stamp=latest when running ant.

    To release a previous stable version, update release.stamp to the
    appropriate version tag, which is just the date the version was released
    formatted as YYYY-MM-DD. To see all the version tags, run:

    $ git tag
  -->
  <property name="release.stamp" value="unstable" />


  <!--
  ==============================================================================
    TARGETS
  ==============================================================================
  -->

  <target name="init" description="Initialize the build directory.">
    <mkdir dir="${build.dir}" />
    <mkdir dir="${classes.dir}" />
    <copy file="${closure-tools-config.xml}" todir="${build.dir}" />
    <tstamp>
      <format property="YEAR" pattern="yyyy" />
      <format property="DATE_TODAY" pattern="yyyy-MM-dd HH:mm:ss" />
    </tstamp>
    <manifest file="${build.dir}/MANIFEST.MF">
      <attribute name="Built-By" value="${user.name}"/>
      <attribute name="Built-Date" value="${DATE_TODAY}"/>
      <attribute name="Release" value="${release.stamp}"/>
    </manifest>
    <manifest file="${build.dir}/BUILDER_PLUS_MANIFEST.MF">
      <attribute name="Built-By" value="${user.name}"/>
      <attribute name="Built-Date" value="${DATE_TODAY}"/>
      <attribute name="Main-Class"
          value="org.closureant.builderplus.cli.Main" />
      <attribute name="Release" value="${release.stamp}"/>
    </manifest>
  </target>


  <target name="clean" description="Delete all files created by this script.">
    <delete dir="${build.dir}" />
  </target>


  <target name="compile" depends="init"
      description="Compiles the Java sources.">
    <javac srcdir="${src.dir}" destdir="${classes.dir}"
        classpathref="classpath" debug="on" deprecation="on"
        includeantruntime="false"
        source="1.6"
        target="1.6">
      <compilerarg value="-Xlint"/>
    </javac>
  </target>

  
  <target name="jar"
      description="Do not execute this target directly. Run the 'build' target
instead. Creates a standalone closure-ant.jar.&#13;&#10;">
    <jar destfile="${closure-ant.jar}" basedir="${classes.dir}" 
        update="true" manifest="${build.dir}/MANIFEST.MF" duplicate="preserve">

      <zipfileset includes="task-definitions.xml" dir="${resources.dir}" />

      <zipfileset includes="**/*.class"
          src="${lib.dir}/template-extensions-for-closure-ant-tasks.jar" />
      <zipfileset includes="resources/*soy*"
          src="${lib.dir}/template-extensions-for-closure-ant-tasks.jar" />

      <zipfileset includes="**/*.class" src="${test.dir}/lib/ant-antunit.jar" />

      <zipfileset includes="**/*.class" src="${lib.dir}/args4j-2.0.9.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/closure-stylesheets-no-deps.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/gson-2.1.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guava-12.0.jar" />

      <zipfileset src="${lib.dir}/jsr305-1.3.9.jar">
        <include name="javax/annotation/Nullable.class" />
      </zipfileset>      
      <!--
        Ant dependencies.
      -->
      <zipfileset src="${lib.dir}/ant-1.8.2.jar">
        <exclude name="org/apache/tools/zip/*" />
        <exclude name="org/apache/tools/ant/dispatch/*" />
        <exclude name="org/apache/tools/ant/filters/*" />
        <exclude name="org/apache/tools/ant/input/*" />
        <exclude name="org/apache/tools/ant/listener/*" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/ant-launcher-1.8.2.jar" />
    </jar>
  </target>


  <target name="jar-no-ant-deps" depends="compile"
      description="Creates a closure-ant.jar excluding ant dependencies
(i.e. the jar relies on the local ant installation [recommend Ant 1.8.0 or
newer]).&#13;&#10;">
    <jar destfile="${closure-ant-no-ant-deps.jar}"
        basedir="${classes.dir}" update="true"
        manifest="${build.dir}/MANIFEST.MF" duplicate="preserve">

      <zipfileset includes="task-definitions.xml" dir="${resources.dir}" />

      <zipfileset includes="**/*.class"
          src="${lib.dir}/closure-commons-no-deps.jar" />
      <zipfileset includes="**/*.class"
          src="${lib.dir}/template-extensions-for-closure-ant-tasks.jar" />
      <zipfileset includes="resources/*soy*"
          src="${lib.dir}/template-extensions-for-closure-ant-tasks.jar" />

      <zipfileset includes="**/*.class" src="${test.dir}/lib/ant-antunit.jar" />

      <zipfileset includes="**/*.class" src="${lib.dir}/args4j-2.0.9.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/closure-stylesheets-no-deps.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/gson-2.1.jar" />

      <zipfileset includes="**/*.class" src="${lib.dir}/guava-12.0.jar">
        <exclude name="com/google/common/annotations/*" />
        <exclude name="com/google/common/cache/*" />
        <exclude name="com/google/common/eventbus/*" />
        <exclude name="com/google/common/hash/*" />
        <exclude name="com/google/common/math/*" />
        <exclude name="com/google/common/net/*" />
        <exclude name="com/google/common/util/*" />
      </zipfileset>

      <zipfileset src="${lib.dir}/jsr305-1.3.9.jar">
        <include name="javax/annotation/Nullable.class" />
      </zipfileset>
    </jar>
  </target>


  <target name="builder-plus-jar"
      description="Do not execute this target directly. Run the 'build' target
instead. Creates a standalone executable builderplus.jar.&#13;&#10;">
    <jar destfile="${builderplus.jar}" basedir="${classes.dir}" update="true"
        manifest="${build.dir}/BUILDER_PLUS_MANIFEST.MF" duplicate="preserve">

      <zipfileset includes="**/*.class" src="${lib.dir}/gson-2.1.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/args4j-2.0.9.jar" />

      <zipfileset includes="**/*.class" src="${lib.dir}/guava-12.0.jar">
        <exclude name="com/google/common/annotations/*" />
        <exclude name="com/google/common/cache/*" />
        <exclude name="com/google/common/eventbus/*" />
        <exclude name="com/google/common/hash/*" />
        <exclude name="com/google/common/math/*" />
        <exclude name="com/google/common/net/*" />
        <exclude name="com/google/common/util/*" />
      </zipfileset>

      <zipfileset src="${lib.dir}/ant-1.8.2.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/ant-launcher-1.8.2.jar" />
    </jar>
  </target>


  <target name="jar-no-deps" depends="compile"
      description="Creates a non-standalone closure-ant.jar excluding
dependencies (i.e. no ant, gson, or guava classes). However, all dependencies
in the package org.closureant are included.&#13;&#10;">
    <jar destfile="${closure-ant-no-deps.jar}" basedir="${classes.dir}"
        update="false" manifest="${build.dir}/MANIFEST.MF" duplicate="preserve">
      
      <zipfileset includes="task-definitions.xml" dir="${resources.dir}" />

      <zipfileset includes="org/closureextensions/**/*.class"
          src="${lib.dir}/template-extensions-for-closure-ant-tasks.jar" />
      <zipfileset includes="resources/*soy*"
          src="${lib.dir}/template-extensions-for-closure-ant-tasks.jar" />

      <zipfileset includes="**/*.class" src="${test.dir}/lib/ant-antunit.jar" />
    </jar>
  </target>
  
  
  <target name="build" depends="compile, jar, builder-plus-jar"
      description="Creates standalone closure-ant.jar and executable
builderplus.jar." />
  

  <target name="javadoc"
      description="Generates complete javadoc.">
    <mkdir dir="${javadoc.dir}" />
    <javadoc
        sourcepath="${src.dir}"
        additionalparam="-notimestamp"
        destdir="${javadoc.dir}"
        author="false"
        windowtitle="Ant Closure Tools"
        classpathref="classpath"
        doctitle="Ant Closure Tools">
      <link href="http://docs.oracle.com/javase/7/docs/api/" />
      <link href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/" />
      <link href="http://docs.guava-libraries.googlecode.com/git/javadoc/" />
      <link href="http://evgeny-goldin.org/javadoc/ant/api/" />
      <!-- TODO(cpeisert): Add link to closure-template-extensions once API docs published -->
      <bottom>
        <![CDATA[
        <div id="copyright" style="float:left">
          <p>Copyright (C) 2012-${YEAR}, Christopher Peisert</p>
        </div>
        ]]>
      </bottom>
    </javadoc>
  </target>

  
  <target name="release" 
      depends="compile, jar, builder-plus-jar, javadoc"
      description="Creates standalone closure-ant-&lt;release.stamp>.jar,
executable builderplus-&lt;release.stamp>.jar, and generates JavaDoc.&#13;&#10;">
    <move file="${closure-ant.jar}"
        tofile="${build.dir}/closure-ant-${release.stamp}.jar" />
    <move file="${builderplus.jar}"
        tofile="${build.dir}/builderplus-${release.stamp}.jar" />
  </target>
  
  
  <target name="test" depends="build"
      description="Run all JUnit and AntUnit tests.">
    <ant dir="${test.dir}" target="clean" inheritAll="false" />
    <ant dir="${test.dir}" target="test" inheritAll="false" />
  </target>
</project>
