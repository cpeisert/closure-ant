<?xml version="1.0" encoding="UTF-8"?>
<!--
Copyright (C) 2012 Christopher Peisert. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<project name="antclosuretools-main" basedir="." default="jar">

  <!-- Use JDK 1.6 to build jar file. Use JDK 1.7 to generate JavaDoc. -->
  <property name="JDK1.6.dir" location="/usr/lib/jvm/jdk1.6" />
  <property name="JDK1.7.dir" location="/usr/lib/jvm/jdk1.7" />
  <property name="javac1.6" location="${JDK1.6.dir}/bin/javac" />
  <property name="javac1.7" location="${JDK1.7.dir}/bin/javac" />
  <property name="javadoc1.7" location="${JDK1.7.dir}/bin/javadoc" />
  
  <!--
  ==============================================================================
    Inputs to the build process.
  ==============================================================================
  -->

  <property name="src.dir" value="${basedir}/src" />
  <property name="lib.dir" value="${basedir}/lib" />
  <property name="resources.dir" value="${basedir}/resources" />
  <property name="test.dir" value="${basedir}/test" />
  <property name="antclosuretools.xml"
      value="${resources.dir}/antclosuretools.xml" />

  <path id="classpath">
    <fileset dir="${lib.dir}" includes="**/*.jar" />
  </path>


  <!--
  ==============================================================================
    Outputs from the build process.
  ==============================================================================
  -->

  <property name="build.dir" location="${basedir}/build" />
  <property name="classes.dir" location="${build.dir}/classes" />
  <property name="classes1.7.dir"
      location="${build.dir}/classes1.7" />
  <property name="antclosuretools.jar" 
      location="${build.dir}/antclosuretools.jar" />
  <property name="builderplus.jar" location="${build.dir}/builderplus.jar" />

  <property name="javadoc.dir" value="${build.dir}/javadoc" />

  <!-- To release a new stable version of closure-ant-tasks, update
    release.stamp to 'latest' or pass -Drelease.stamp=latest when running ant. -->
  <property name="release.dir" value="${basedir}/release" />
  <property name="release.stamp" value="unstable" />

  <condition property="build.antclosuretools.xml.available">
    <available file="${build.dir}/antclosuretools.xml" />
  </condition>

  <!--
  ==============================================================================
    TARGETS
  ==============================================================================
  -->

  <target name="init" description="Initialize the build directory.">
    <mkdir dir="${build.dir}" />
    <mkdir dir="${classes.dir}" />
    <copy file="${antclosuretools.xml}" todir="${build.dir}" />
    <tstamp>
      <format property="YEAR" pattern="yyyy" />
      <format property="DATE_TODAY" pattern="yyyy-MM-dd HH:mm:ss" />
    </tstamp>
    <manifest file="${build.dir}/MANIFEST.MF">
      <attribute name="Built-By" value="${user.name}"/>
      <attribute name="Built-Date" value="${DATE_TODAY}"/>
    </manifest>
    <manifest file="${build.dir}/BUILDER_PLUS_MANIFEST.MF">
      <attribute name="Built-By" value="${user.name}"/>
      <attribute name="Built-Date" value="${DATE_TODAY}"/>
      <attribute name="Main-Class" value="org.builderplus.cli.Main" />
    </manifest>
  </target>


  <target name="clean" description="Delete all files created by this script.">
    <delete dir="${build.dir}" />
  </target>


  <target name="compile" depends="init"
      description="Compiles the Java source using the system's default JDK.">
    <javac srcdir="${src.dir}" destdir="${classes.dir}"
        classpathref="classpath" debug="on" deprecation="on"
        source="1.6"
        includeantruntime="false">
      <compilerarg value="-Xlint"/>
    </javac>
  </target>

  
  <target name="jar" depends="compile"
      description="Creates a standalone antclosuretools.jar (including the
ant dependencies) using the system's default JDK.">
    <jar destfile="${antclosuretools.jar}" basedir="${classes.dir}" 
        update="true" manifest="${build.dir}/MANIFEST.MF" duplicate="preserve">
      <zipfileset includes="**/*.class" src="${lib.dir}/gson-2.1.jar" />
      <zipfileset dir="${resources.dir}" includes="*soy*" prefix="resources/" />
      <!--
        Closure Templates dependencies.
      -->
      <zipfileset includes="**/*.class" src="${lib.dir}/aopalliance.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/args4j-2.0.9.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guava-11.0.jar">
        <exclude name="com/google/common/annotations/*" />
        <exclude name="com/google/common/cache/*" />
        <exclude name="com/google/common/eventbus/*" />
        <exclude name="com/google/common/hash/*" />
        <exclude name="com/google/common/math/*" />
        <exclude name="com/google/common/net/*" />
        <exclude name="com/google/common/util/*" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-assistedinject-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-multibindings-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/icu4j-49_1.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/javax.inject.jar" />
      <zipfileset src="${lib.dir}/jsr305-1.3.9.jar">
        <include name="javax/annotation/Nullable.class" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/soy-excluding-deps.jar" />
      <!--
        Ant dependencies.
      -->
      <zipfileset src="${lib.dir}/ant-1.8.2.jar">
        <exclude name="org/apache/tools/zip/*" />
        <exclude name="org/apache/tools/ant/dispatch/*" />
        <exclude name="org/apache/tools/ant/filters/*" />
        <exclude name="org/apache/tools/ant/input/*" />
        <exclude name="org/apache/tools/ant/listener/*" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/ant-launcher-1.8.2.jar" />
    </jar>
  </target>


  <target name="jar-excluding-ant-deps" depends="compile"
      description="Creates an antclosuretools.jar excluding the ant dependencies
(i.e. the jar relies on the local ant installation [recommend Ant 1.8.0 or
newer]) using the system's default JDK.">
    <jar destfile="${antclosuretools.jar}" basedir="${classes.dir}"
        update="true" manifest="${build.dir}/MANIFEST.MF" duplicate="preserve">
      <zipfileset includes="**/*.class" src="${lib.dir}/gson-2.1.jar" />
      <zipfileset dir="${resources.dir}" includes="*soy*" prefix="resources/" />
      <!--
        Closure Templates dependencies.
      -->
      <zipfileset includes="**/*.class" src="${lib.dir}/aopalliance.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/args4j-2.0.9.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guava-11.0.jar">
        <exclude name="com/google/common/annotations/*" />
        <exclude name="com/google/common/cache/*" />
        <exclude name="com/google/common/eventbus/*" />
        <exclude name="com/google/common/hash/*" />
        <exclude name="com/google/common/math/*" />
        <exclude name="com/google/common/net/*" />
        <exclude name="com/google/common/util/*" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-assistedinject-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-multibindings-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/icu4j-49_1.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/javax.inject.jar" />
      <zipfileset src="${lib.dir}/jsr305-1.3.9.jar">
        <include name="javax/annotation/Nullable.class" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/soy-excluding-deps.jar" />
    </jar>
  </target>


  <target name="builder-plus-jar" depends="compile"
      description="Creates a standalone builderplus.jar using the system's default JDK.">
    <jar destfile="${builderplus.jar}" basedir="${classes.dir}" update="true"
        manifest="${build.dir}/BUILDER_PLUS_MANIFEST.MF" duplicate="preserve">
      <zipfileset includes="**/*.class" src="${lib.dir}/gson-2.1.jar" />
      <zipfileset dir="${resources.dir}" includes="*soy*" prefix="resources/" />
      <!--
        Ant dependencies.
      -->
      <zipfileset src="${lib.dir}/ant-1.8.2.jar">
        <exclude name="org/apache/tools/zip/*" />
        <exclude name="org/apache/tools/ant/dispatch/*" />
        <exclude name="org/apache/tools/ant/filters/*" />
        <exclude name="org/apache/tools/ant/input/*" />
        <exclude name="org/apache/tools/ant/listener/*" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/ant-launcher-1.8.2.jar" />
    </jar>
  </target>


  <target name="build" depends="jar, builder-plus-jar"
      description="Creates standalone antclosuretools.jar and builderplus.jar
using the system's default JDK." />


  <target name="jar-no-deps" depends="compile"
      description="Creates a non-standalone antclosuretools.jar excluding
dependencies (i.e. no ant, gson, or guava classes).">
    <jar destfile="${antclosuretools.jar}" basedir="${classes.dir}"
        update="false" manifest="${build.dir}/MANIFEST.MF" duplicate="preserve">
      <zipfileset dir="${resources.dir}" includes="*soy*" prefix="resources/" />
    </jar>
  </target>
  

  <!--
    For "release" builds, use JDK 1.6 to compile sources for the jar file and
    JDK 1.7 to compile sources for JavaDoc.
  -->
  
  <target name="compile_1.6" depends="init"
      description="Compiles the Java source using JDK 1.6.">
    <javac executable="${javac1.6}"
        srcdir="${src.dir}" destdir="${classes.dir}"
        classpathref="classpath" debug="on" deprecation="on"
        includeantruntime="false"
        source="1.6"
        target="1.6">
      <compilerarg value="-Xlint"/>
    </javac>
  </target>


  <target name="jar_1.6" depends="compile_1.6"
      description="Creates a standalone antclosuretools.jar using JDK 1.6.">
    <jar destfile="${antclosuretools.jar}" basedir="${classes.dir}"
        update="true" manifest="${build.dir}/MANIFEST.MF" duplicate="preserve">
      <zipfileset src="${lib.dir}/gson-2.1.jar" includes="**/*.class" />
      <zipfileset dir="${resources.dir}" includes="*soy*" prefix="resources/" />
      <!--
        Closure Templates dependencies.
      -->
      <zipfileset includes="**/*.class" src="${lib.dir}/aopalliance.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/args4j-2.0.9.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guava-11.0.jar">
        <exclude name="com/google/common/annotations/*" />
        <exclude name="com/google/common/cache/*" />
        <exclude name="com/google/common/eventbus/*" />
        <exclude name="com/google/common/hash/*" />
        <exclude name="com/google/common/math/*" />
        <exclude name="com/google/common/net/*" />
        <exclude name="com/google/common/util/*" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-assistedinject-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guice-multibindings-3.0.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/icu4j-49_1.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/javax.inject.jar" />
      <zipfileset src="${lib.dir}/jsr305-1.3.9.jar">
        <include name="javax/annotation/Nullable.class" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/soy-excluding-deps.jar" />
      <!--
        Ant dependencies.
      -->
      <zipfileset src="${lib.dir}/ant-1.8.2.jar">
        <exclude name="org/apache/tools/zip/*" />
        <exclude name="org/apache/tools/ant/dispatch/*" />
        <exclude name="org/apache/tools/ant/filters/*" />
        <exclude name="org/apache/tools/ant/input/*" />
        <exclude name="org/apache/tools/ant/listener/*" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/ant-launcher-1.8.2.jar" />
    </jar>
  </target>


  <target name="builder-plus-jar_1.6" depends="compile_1.6"
      description="Creates a standalone builderplus.jar using JDK 1.6.">
    <jar destfile="${builderplus.jar}" basedir="${classes.dir}" update="true"
        manifest="${build.dir}/BUILDER_PLUS_MANIFEST.MF" duplicate="preserve">
      <zipfileset includes="**/*.class" src="${lib.dir}/args4j-2.0.9.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/gson-2.1.jar" />
      <zipfileset includes="**/*.class" src="${lib.dir}/guava-11.0.jar"/>
      <zipfileset src="${lib.dir}/jsr305-1.3.9.jar">
        <include name="javax/annotation/Nullable.class" />
      </zipfileset>
      <zipfileset dir="${resources.dir}" includes="*soy*" prefix="resources/" />
      <!--
        Ant dependencies.
      -->
      <zipfileset src="${lib.dir}/ant-1.8.2.jar">
        <exclude name="org/apache/tools/zip/*" />
        <exclude name="org/apache/tools/ant/dispatch/*" />
        <exclude name="org/apache/tools/ant/filters/*" />
        <exclude name="org/apache/tools/ant/input/*" />
        <exclude name="org/apache/tools/ant/listener/*" />
      </zipfileset>
      <zipfileset includes="**/*.class" src="${lib.dir}/ant-launcher-1.8.2.jar" />
    </jar>
  </target>


  <target name="compile_1.7" depends="init"
      description="Compiles the Java sources using JDK 1.7.">
    <mkdir dir="${classes1.7.dir}" />
    <javac executable="${javac1.7}"
        srcdir="${src.dir}" destdir="${classes1.7.dir}"
        classpathref="classpath" debug="on" deprecation="on"
        includeantruntime="false"
        source="1.7"
        target="1.7">
      <compilerarg value="-Xlint"/>
    </javac>
  </target>
  

  <target name="javadoc_1.7"
      depends="compile_1.7"
      description="Generates complete javadoc using JDK 1.7.">
    <mkdir dir="${javadoc.dir}" />
    <javadoc executable="${javadoc1.7}" 
        sourcepath="${src.dir}"
        additionalparam="-notimestamp"
        destdir="${javadoc.dir}"
        author="false"
        windowtitle="Ant Closure Tools"
        classpathref="classpath"
        doctitle="Ant Closure Tools (${release.stamp})"
        bottom='&lt;div id="copyright" style="float:left">&lt;p>Copyright (C) 2012-${YEAR}, Christopher Peisert&lt;/p>&lt;/div>'>
      <link href="http://docs.oracle.com/javase/7/docs/api/" />
      <link href="http://evgeny-goldin.org/javadoc/ant/api/" />
    </javadoc>
    <delete dir="${classes1.7.dir}" />
  </target>

  
  <target name="release" 
      depends="jar_1.6, builder-plus-jar_1.6, javadoc_1.7"
      description="Creates standalone antclosuretools.jar and builderplus.jar
using JDK 1.6 and generates JavaDoc using JDK 1.7.">
  </target>
  
  
  <target name="test" depends="build"
      description="Run all JUnit and AntUnit tests.">
    <fail unless="build.antclosuretools.xml.available"
        message="Tests aborted. File not found:
[build/antclosuretools.xml]." />
    <ant dir="${test.dir}" target="test" inheritAll="false" />
  </target>
</project>